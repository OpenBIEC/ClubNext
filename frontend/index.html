<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Index Page - Twitter-like Layout with Carousel</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/markdown.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .carousel-inner img {
            height: 400px;
            object-fit: cover;
        }
        @media (min-width: 992px) {
            .sticky-sidebar {
                position: sticky;
                top: 100px;
                height: calc(100vh - 40px);
                overflow-y: auto;
            }
        }
        @media (max-width: 767.98px) {
            .hide-on-mobile {
                display: none !important;
            }
        }
        .sticky-navbar {
            position: sticky;
            top: 0;
            z-index: 1020;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light sticky-navbar">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-house-fill"></i> Club Next
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto" id="navItems">
                    <!-- Dynamic content based on login status -->
                </ul>
                <form class="d-flex" role="search">
                    <input class="form-control me-2" type="search" placeholder="Search..." aria-label="Search">
                    <button class="btn btn-outline-success" type="submit">
                        <i class="bi bi-search"></i>
                    </button>
                </form>
            </div>
        </div>
    </nav>
    
    <div id="focusCarousel" class="carousel slide mt-4" data-bs-ride="carousel">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img src="https://placehold.co/1200x400" class="d-block w-100" alt="Slide 1">
                <div class="carousel-caption d-none d-md-block">
                    <h5>Focus Slide 1</h5>
                    <p>Some representative placeholder content for the first slide.</p>
                </div>
            </div>
            <div class="carousel-item">
                <img src="https://placehold.co/1200x400" class="d-block w-100" alt="Slide 2">
                <div class="carousel-caption d-none d-md-block">
                    <h5>Focus Slide 2</h5>
                    <p>Some representative placeholder content for the second slide.</p>
                </div>
            </div>
            <div class="carousel-item">
                <img src="https://placehold.co/1200x400" class="d-block w-100" alt="Slide 3">
                <div class="carousel-caption d-none d-md-block">
                    <h5>Focus Slide 3</h5>
                    <p>Some representative placeholder content for the third slide.</p>
                </div>
            </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#focusCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#focusCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>

    <div class="container mt-5">
        <div class="row">
            <div class="col-md-3 hide-on-mobile sticky-sidebar">
                <div class="card d-none" id="userViewProfileCard">
                    <div class="card-body text-center">
                        <img src="https://placehold.co/150" alt="User Avatar" class="rounded-circle mb-3" width="100" height="100" id="userAvatar">
                        <h5 class="card-title" id="userProfileName">Username</h5>
                        <p class="card-text text-muted" id="userProfileBio">"This is a short user bio."</p>
                        <div class="d-flex justify-content-between my-3">
                            <div>
                                <h6 class="mb-0" id="numberFollowers">120</h6>
                                <small class="text-muted">Followers</small>
                            </div>
                            <div>
                                <h6 class="mb-0" id="numberFollowing">80</h6>
                                <small class="text-muted">Following</small>
                            </div>
                        </div>
                        <p class="text-muted"><small id="userJoinedDate">Joined: January 1, 2024</small></p>
                        <p class="card-text" id="userProfileText">Welcome back, user123!</p>
                        <div class="d-grid gap-2">
                            <a href="/private_message.html" id="viewMessagesButton" class="btn btn-outline-success position-relative">
                                <i class="bi bi-chat"></i> View Messages
                                <span id="messageNotification" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">!</span>
                            </a>
                            <a href="/profile.html" id="viewProfileButton" class="btn btn-outline-primary">
                                <i class="bi bi-person"></i> View Profile
                            </a>
                        </div>
                    </div>
                </div>
                                             
                <div class="card" id="userLoginProfileCard">
                    <div class="card-body">
                        <h5 class="card-title" id="userProfileTitle">User Profile</h5>
                        <p class="card-text" id="userLoginText">Please log in to see your profile.</p>
                        <a href="/login.html" id="loginButton" class="btn btn-primary">Log In</a>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div id="postList">
                    <div class="mb-3">
                        <div class="card">
                            <div class="card-body d-flex">
                                <img id="userAvatar" src="https://placeholder.co/50" alt="User Avatar" class="rounded-circle me-3" style="width: 50px; height: 50px;">
                                <div class="w-100">
                                    <textarea class="form-control mb-2" id="postContent" rows="3" placeholder="What's happening?"></textarea>
                                    <div id="imagePreview" class="mb-2" style="display: none;">
                                        <img id="previewImage" src="" alt="Preview" class="img-fluid rounded" style="max-height: 200px;">
                                    </div>
                                    <div class="d-flex justify-content-start flex-wrap gap-2">
                                        <label for="imageUpload" class="btn btn-outline-primary">
                                            <i class="bi bi-image"></i> Image
                                            <input type="file" id="imageUpload" class="d-none" accept="image/*">
                                        </label>
                                        <label for="fileUpload" class="btn btn-outline-secondary">
                                            <i class="bi bi-file-earmark"></i> File
                                            <input type="file" id="fileUpload" class="d-none">
                                        </label>
                                        <label for="videoUpload" class="btn btn-outline-danger">
                                            <i class="bi bi-camera-video"></i> Video
                                            <input type="file" id="videoUpload" class="d-none" accept="video/*">
                                        </label>
                                        <button id="postButton" class="btn btn-primary">
                                            <i class="bi bi-send"></i> Post
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>                          

                <div id="loadingIndicator" class="text-center mt-3">
                    <span class="spinner-border text-primary" role="status"></span>
                </div>
            </div>  

            <div class="col-md-3 hide-on-mobile sticky-sidebar">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Trending Topics</h5>
                        <ul class="list-unstyled mb-4">
                            <li class="d-flex align-items-center mb-2">
                                <a href="/official.html" class="text-decoration-none d-flex align-items-center">
                                    <i class="bi bi-megaphone-fill text-danger me-2"></i>
                                    <span>论坛官方</span>
                                </a>
                            </li>
                            <li class="d-flex align-items-center mb-2">
                                <a href="/biec_community.html" class="text-decoration-none d-flex align-items-center">
                                    <i class="bi bi-building text-primary me-2"></i>
                                    <span>BIEC社团</span>
                                </a>
                            </li>
                            <li class="d-flex align-items-center mb-2">
                                <a href="/gamehub.html" class="text-decoration-none d-flex align-items-center">
                                    <i class="bi bi-controller text-warning me-2"></i>
                                    <span>GameHub</span>
                                </a>
                            </li>
                            <li class="d-flex align-items-center mb-2">
                                <a href="/onlystudies.html" class="text-decoration-none d-flex align-items-center">
                                    <i class="bi bi-pencil-fill text-info me-2"></i>
                                    <span>Only Study</span>
                                </a>
                            </li>
                            <li class="d-flex align-items-center">
                                <a href="/life.html" class="text-decoration-none d-flex align-items-center">
                                    <i class="bi bi-house-heart-fill text-primary me-2"></i>
                                    <span>Life</span>
                                </a>
                            </li>
                        </ul>
                        <div id="tagsSuggestion" class="tags-container mb-3">
                            <span class="badge bg-primary">Technology</span>
                            <span class="badge bg-success">Science</span>
                            <span class="badge bg-warning text-dark">Health</span>
                            <span class="badge bg-info text-dark">Education</span>
                            <span class="badge bg-secondary">Travel</span>
                            <span class="badge bg-danger">Sports</span>
                        </div>
                        <a href="#" class="btn btn-outline-primary w-100 mb-3">Explore</a>
                        <a href="/create_post.html" class="btn btn-success w-100">
                            <i class="bi bi-plus-circle"></i> Create Post
                        </a>
                    </div>
                </div>
            </div>
       
        </div>
    </div>

    <footer class="text-center mt-5">
        <p class="mb-0">© 2024 OpenBIEC. All rights reserved.</p>
        <p class="text-muted">Powered by a lightweight C++ backend and Bootstrap frontend. Visit our <a href="https://github.com/OpenBIEC/ClubNext" target="_blank">GitHub</a> for source code.</p>
    </footer> 

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="/js/api/user.js"></script>
    <script src="/js/api/post.js"></script>
    <script src="/js/api/social.js"></script>
    <script src="/js/navbar.js"></script>
    <script>
        updateNavBar();

        document.addEventListener("DOMContentLoaded", function () {
            function fetchUnreadMessages() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve({ hasUnread: true });
                    }, 300);
                });
            }
        
            function updateUserProfile(profile) {
                document.getElementById("userAvatar").src = profile.avatar;
                document.getElementById("userProfileName").textContent = profile.username;
                document.getElementById("userProfileBio").textContent = profile.bio;
                document.getElementById("numberFollowers").textContent = profile.followers;
                document.getElementById("numberFollowing").textContent = profile.following;
                document.getElementById("userJoinedDate").textContent = `Joined: ${profile.joinedDate}`;
                document.getElementById("userProfileText").textContent = `Welcome back, ${profile.username}!`;
            }
        
            function updateMessageNotification(hasUnread) {
                const notificationBadge = document.getElementById("messageNotification");
                if (hasUnread) {
                    notificationBadge.classList.remove("d-none");
                } else {
                    notificationBadge.classList.add("d-none");
                }
            }
        
            isUserLoggedIn().then((loggedIn) => {
                if (loggedIn) {
                    document.getElementById("userLoginProfileCard").classList.add("d-none");
                    document.getElementById("userViewProfileCard").classList.remove("d-none");
        
                    fetchUserProfile().then((profile) => {
                        if (profile) {
                            updateUserProfile(profile);
                        }
                    });
        
                    fetchUnreadMessages().then((data) => {
                        updateMessageNotification(data.hasUnread);
                    });
                } else {
                    document.getElementById("userLoginProfileCard").classList.remove("d-none");
                    document.getElementById("userViewProfileCard").classList.add("d-none");
                    document.getElementById("userLoginText").textContent = "Please log in to see your profile.";
                }
            });
        });            

        document.addEventListener("DOMContentLoaded", () => {
            const postList = document.getElementById("postList");
            const loadingIndicator = document.getElementById("loadingIndicator");
            let isLoading = false;
        
            const observer = new IntersectionObserver(async (entries) => {
                if (entries[0].isIntersecting && !isLoading) {
                    isLoading = true;
                    const shouldContinue = await loadMorePosts(postList, loadingIndicator);
                    isLoading = false;
        
                    if (!shouldContinue) {
                        observer.disconnect();
                    }
                }
            });
        
            observer.observe(loadingIndicator);
        
            postList.addEventListener("click", async (event) => {
                const button = event.target.closest("button");
                if (!button) return;
            
                const postId = button.dataset.id;
            
                if (button.classList.contains("like-button")) {
                    const icon = button.querySelector("i");
                    let likeCount = parseInt(button.textContent.trim(), 10);
                    const isLiked = button.classList.contains("text-danger");
            
                    try {
                        let updatedCount;
                        if (!isLiked) {
                            const response = await likePost(postId);
                            updatedCount = response.like_count;
                        } else {
                            const response = await unlikePost(postId);
                            updatedCount = response.like_count;
                        }

                        button.classList.toggle("text-danger", !isLiked);
                        button.classList.toggle("text-muted", isLiked);
                        icon.classList.toggle("bi-heart-fill", !isLiked);
                        icon.classList.toggle("bi-heart", isLiked);
                        button.textContent = ` ${updatedCount}`;
                        button.prepend(icon);
                    } catch (error) {
                        alert(`Failed to ${isLiked ? "unlike" : "like"} the post. Please try again.`);
                    }
                }
            
                if (button.classList.contains("comment-button")) {
                    alert(`View comments for post ID: ${postId}`);
                }
            });            
        });
        
        document.addEventListener("DOMContentLoaded", async () => {
            const tagsContainer = document.getElementById("tagsSuggestion");

            try {
                const data = await fetchTags();
                const tags = data.tags;

                tagsContainer.innerHTML = '';

                tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'badge';
                    tagElement.textContent = tag.name;

                    const colors = [
                        'bg-primary', 'bg-success', 'bg-warning text-dark',
                        'bg-info text-dark', 'bg-secondary', 'bg-danger'
                    ];
                    const randomColor = colors[Math.floor(Math.random() * colors.length)];
                    tagElement.classList.add(...randomColor.split(' '));

                    tagsContainer.appendChild(tagElement);
                });
            } catch (error) {
                console.error('Failed to update tags:', error);
                tagsContainer.innerHTML = '<span class="text-danger">Failed to load tags.</span>';
            }
        });

        document.addEventListener("DOMContentLoaded", async () => {
            const postContent = document.getElementById("postContent");
            const imageUpload = document.getElementById("imageUpload");
            const fileUpload = document.getElementById("fileUpload");
            const videoUpload = document.getElementById("videoUpload");
            const postButton = document.getElementById("postButton");
            let currentDraftId = null;

            async function autoCreateDraft(content) {
                if (currentDraftId) return;
                try {
                    const response = await fetch('/api/draft', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ content: content || "" })
                    });
                    if (!response.ok) {
                        throw new Error("Failed to create draft");
                    }
                    const data = await response.json();
                    currentDraftId = data.draft_id;
                } catch (error) {
                    console.error("Error creating draft:", error);
                }
            }

            async function updateDraft(content) {
                if (!currentDraftId) {
                    await autoCreateDraft(content);
                }
                try {
                    await fetch('/api/draft', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ draft_id: currentDraftId, content })
                    });
                } catch (error) {
                    console.error("Error updating draft:", error);
                }
            }

            async function uploadMedia(file, type) {
                if (!currentDraftId) {
                    await autoCreateDraft(postContent.value);
                }
                try {
                    const formData = new FormData();
                    formData.append(type, file);
                    await fetch(`/api/draft/media`, {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });
                } catch (error) {
                    console.error(`Error uploading ${type}:`, error);
                }
            }
        
            async function publishDraft() {
                if (!currentDraftId) {
                    alert("Please add content or media before publishing.");
                    return;
                }
                try {
                    const response = await fetch('/api/draft/publish', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ draft_id: currentDraftId })
                    });
                    if (!response.ok) {
                        throw new Error("Failed to publish draft");
                    }
                    alert("Post published successfully!");
                    currentDraftId = null;
                } catch (error) {
                    console.error("Error publishing draft:", error);
                    alert("Failed to publish post.");
                }
            }
        
            postContent.addEventListener("input", () => updateDraft(postContent.value));
            imageUpload.addEventListener("change", (event) => uploadMedia(event.target.files[0], "image"));
            fileUpload.addEventListener("change", (event) => uploadMedia(event.target.files[0], "file"));
            videoUpload.addEventListener("change", (event) => uploadMedia(event.target.files[0], "video"));
            postButton.addEventListener("click", publishDraft);
        });        
        
        
    </script>
</body>
</html>