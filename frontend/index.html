<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Index Page - Twitter-like Layout with Carousel</title>
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/markdown.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .carousel-inner img {
            height: 400px;
            object-fit: cover;
        }
        @media (min-width: 992px) {
            .sticky-sidebar {
                position: sticky;
                top: 100px;
                height: calc(100vh - 40px);
                overflow-y: auto;
            }
        }
        @media (max-width: 767.98px) {
            .hide-on-mobile {
                display: none !important;
            }
        }
        .sticky-navbar {
            position: sticky;
            top: 0;
            z-index: 1020;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light sticky-navbar">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-house-fill"></i> Club Next
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="./profile.html">
                            <i class="bi bi-person-circle"></i> Profile
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./private_message.html">
                            <i class="bi bi-chat-dots"></i> Messages
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./drafts.html">
                            <i class="bi bi-file-earmark-text"></i> Drafts
                        </a>
                    </li>
                </ul>
                <form class="d-flex" role="search">
                    <input class="form-control me-2" type="search" placeholder="Search..." aria-label="Search">
                    <button class="btn btn-outline-success" type="submit">
                        <i class="bi bi-search"></i>
                    </button>
                </form>
            </div>
        </div>
    </nav>
    
    <div id="focusCarousel" class="carousel slide mt-4" data-bs-ride="carousel">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img src="https://placehold.co/1200x400" class="d-block w-100" alt="Slide 1">
                <div class="carousel-caption d-none d-md-block">
                    <h5>Focus Slide 1</h5>
                    <p>Some representative placeholder content for the first slide.</p>
                </div>
            </div>
            <div class="carousel-item">
                <img src="https://placehold.co/1200x400" class="d-block w-100" alt="Slide 2">
                <div class="carousel-caption d-none d-md-block">
                    <h5>Focus Slide 2</h5>
                    <p>Some representative placeholder content for the second slide.</p>
                </div>
            </div>
            <div class="carousel-item">
                <img src="https://placehold.co/1200x400" class="d-block w-100" alt="Slide 3">
                <div class="carousel-caption d-none d-md-block">
                    <h5>Focus Slide 3</h5>
                    <p>Some representative placeholder content for the third slide.</p>
                </div>
            </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#focusCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#focusCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>

    <div class="container mt-5">
        <div class="row">
            <div class="col-md-3 hide-on-mobile sticky-sidebar">
                <div class="card d-none" id="userViewProfileCard">
                    <div class="card-body text-center">
                        <img src="https://placehold.co/150" alt="User Avatar" class="rounded-circle mb-3" width="100" height="100" id="userAvatar">
                        <h5 class="card-title" id="userProfileName">Username</h5>
                        <p class="card-text text-muted" id="userProfileBio">"This is a short user bio."</p>
                        <div class="d-flex justify-content-between my-3">
                            <div>
                                <h6 class="mb-0" id="numberFollowers">120</h6>
                                <small class="text-muted">Followers</small>
                            </div>
                            <div>
                                <h6 class="mb-0" id="numberFollowing">80</h6>
                                <small class="text-muted">Following</small>
                            </div>
                        </div>
                        <p class="text-muted"><small id="userJoinedDate">Joined: January 1, 2024</small></p>
                        <p class="card-text" id="userProfileText">Welcome back, user123!</p>
                        <div class="d-grid gap-2">
                            <a href="./private_message.html" id="viewMessagesButton" class="btn btn-outline-success position-relative">
                                <i class="bi bi-chat"></i> View Messages
                                <span id="messageNotification" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">!</span>
                            </a>
                            <a href="./profile.html" id="viewProfileButton" class="btn btn-outline-primary">
                                <i class="bi bi-person"></i> View Profile
                            </a>
                        </div>
                    </div>
                </div>
                                             
                <div class="card" id="userLoginProfileCard">
                    <div class="card-body">
                        <h5 class="card-title" id="userProfileTitle">User Profile</h5>
                        <p class="card-text" id="userLoginText">Please log in to see your profile.</p>
                        <a href="./login.html" id="loginButton" class="btn btn-primary">Log In</a>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div id="postList">
                    <div class="mb-3">
                        <div class="card">
                            <div class="card-body d-flex">
                                <img src="https://placeholder.co/50" alt="User Avatar" class="rounded-circle me-3" style="width: 50px; height: 50px;">
                                <div class="w-100">
                                    <textarea class="form-control mb-2" id="postContent" rows="3" placeholder="What's happening?"></textarea>
                                    <div id="imagePreview" class="mb-2" style="display: none;">
                                        <img id="previewImage" src="" alt="Preview" class="img-fluid rounded" style="max-height: 200px;">
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <label for="imageUpload" class="btn btn-outline-primary">
                                            <i class="bi bi-image"></i> Add Image
                                            <input type="file" id="imageUpload" class="d-none" accept="image/*">
                                        </label>
                                        <button id="postButton" class="btn btn-primary">
                                            <i class="bi bi-send"></i> Post
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
                <div id="loadingIndicator" class="text-center mt-3">
                    <span class="spinner-border text-primary" role="status"></span>
                </div>
            </div>  

            <div class="col-md-3 hide-on-mobile sticky-sidebar">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Trending Topics</h5>
                        <ul class="list-unstyled mb-4">
                            <li class="d-flex align-items-center mb-2">
                                <a href="./official.html" class="text-decoration-none d-flex align-items-center">
                                    <i class="bi bi-megaphone-fill text-danger me-2"></i>
                                    <span>论坛官方</span>
                                </a>
                            </li>
                            <li class="d-flex align-items-center mb-2">
                                <a href="./biec_community.html" class="text-decoration-none d-flex align-items-center">
                                    <i class="bi bi-building text-primary me-2"></i>
                                    <span>BIEC社团</span>
                                </a>
                            </li>
                            <li class="d-flex align-items-center mb-2">
                                <a href="./gamehub.html" class="text-decoration-none d-flex align-items-center">
                                    <i class="bi bi-controller text-warning me-2"></i>
                                    <span>GameHub</span>
                                </a>
                            </li>
                            <li class="d-flex align-items-center mb-2">
                                <a href="./onlystudies.html" class="text-decoration-none d-flex align-items-center">
                                    <i class="bi bi-pencil-fill text-info me-2"></i>
                                    <span>Only Study</span>
                                </a>
                            </li>
                            <li class="d-flex align-items-center">
                                <a href="./life.html" class="text-decoration-none d-flex align-items-center">
                                    <i class="bi bi-house-heart-fill text-primary me-2"></i>
                                    <span>Life</span>
                                </a>
                            </li>
                        </ul>
                        <div class="tags-container mb-3">
                            <span class="badge bg-primary">Technology</span>
                            <span class="badge bg-success">Science</span>
                            <span class="badge bg-warning text-dark">Health</span>
                            <span class="badge bg-info text-dark">Education</span>
                            <span class="badge bg-secondary">Travel</span>
                            <span class="badge bg-danger">Sports</span>
                        </div>
                        <a href="#" class="btn btn-outline-primary w-100 mb-3">Explore</a>
                        <a href="./create_post.html" class="btn btn-success w-100">
                            <i class="bi bi-plus-circle"></i> Create Post
                        </a>
                    </div>
                </div>
            </div>
       
        </div>
    </div>

    <footer class="text-center mt-5">
        <p class="mb-0">© 2024 Club Next. All rights reserved.</p>
        <p class="text-muted">Powered by a lightweight C++ backend and Bootstrap frontend. Visit our <a href="https://github.com/OpenBIEC/ClubNext" target="_blank">GitHub</a> for source code.</p>
    </footer> 

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () { 
            let userLoggedIn = true;
        
            function fetchUserProfile() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve({
                            username: "user123",
                            avatar: "https://placehold.co/150",
                            bio: "Passionate developer and tech enthusiast.",
                            followers: 200,
                            following: 180,
                            joinedDate: "January 1, 2024"
                        });
                    }, 500);
                });
            }
        
            function fetchUnreadMessages() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve({ hasUnread: true }); // 模拟有未读消息
                    }, 300);
                });
            }
        
            function updateUserProfile(profile) {
                document.getElementById("userAvatar").src = profile.avatar;
                document.getElementById("userProfileName").textContent = profile.username;
                document.getElementById("userProfileBio").textContent = profile.bio;
                document.getElementById("numberFollowers").textContent = profile.followers;
                document.getElementById("numberFollowing").textContent = profile.following;
                document.getElementById("userJoinedDate").textContent = `Joined: ${profile.joinedDate}`;
                document.getElementById("userProfileText").textContent = `Welcome back, ${profile.username}!`;
            }
        
            function updateMessageNotification(hasUnread) {
                const notificationBadge = document.getElementById("messageNotification");
                if (hasUnread) {
                    notificationBadge.classList.remove("d-none");
                } else {
                    notificationBadge.classList.add("d-none");
                }
            }
        
            if (userLoggedIn) {
                document.getElementById("userLoginProfileCard").classList.add("d-none");
                document.getElementById("userViewProfileCard").classList.remove("d-none");
        
                fetchUserProfile().then((profile) => {
                    updateUserProfile(profile);
                });
        
                fetchUnreadMessages().then((data) => {
                    updateMessageNotification(data.hasUnread);
                });
            } else {
                document.getElementById("userLoginProfileCard").classList.remove("d-none");
                document.getElementById("userViewProfileCard").classList.add("d-none");
                document.getElementById("userLoginText").textContent = "Please log in to see your profile.";
            }
        });        

        document.addEventListener("DOMContentLoaded", () => {
            const postList = document.getElementById("postList");
            const loadingIndicator = document.getElementById("loadingIndicator");
            let isLoading = false;
        
            let totalAvailablePosts = 50;
            const fetchPostsFromAPI = (limit = 5) => {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        if (totalAvailablePosts <= 0) {
                            resolve([]);
                            return;
                        }
                        const postsToGenerate = Math.min(limit, totalAvailablePosts);
                        const newPosts = [];
                        for (let i = 0; i < postsToGenerate; i++) {
                            const postId = Date.now() + Math.random();
                            newPosts.push({
                                id: postId,
                                username: `user${Math.floor(Math.random() * 100)}`,
                                content: `### Post by user${Math.floor(Math.random() * 100)}\nThis is a dynamically loaded post.\n\n![image](https://placehold.co/114x514)\n\n`,
                                avatar: "https://placehold.co/50",
                                likes: Math.floor(Math.random() * 100),
                                comments: Math.floor(Math.random() * 50),
                                likedByUser: Math.random() > 0.5
                            });
                        }
                        totalAvailablePosts -= postsToGenerate;
                        resolve(newPosts);
                    }, 500);
                });
            };            
        
            const generatePostHTML = ({ id, username, content, avatar, likes, comments, likedByUser }) => `
                <div class="mb-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <img src="${avatar}" alt="${username}'s Avatar" class="rounded-circle me-2" style="width: 40px; height: 40px;">
                                <h6 class="card-subtitle mb-0 text-muted">@${username}</h6>
                            </div>
                            <div class="card-text markdown-content">${marked.parse(content)}</div>
                            <div class="d-flex mt-3">
                                <button class="btn me-2 like-button ${likedByUser ? "text-danger" : "text-muted"}" data-id="${id}">
                                    <i class="bi ${likedByUser ? "bi-heart-fill" : "bi-heart"}"></i> ${likes}
                                </button>
                                <button class="btn comment-button text-muted" data-id="${id}">
                                    <i class="bi bi-chat"></i> ${comments}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        
            const loadMorePosts = async () => {
                if (isLoading) return;
                isLoading = true;
                loadingIndicator.style.display = "block";
        
                const newPosts = await fetchPostsFromAPI(5); // 每次请求 5 条新帖子
                if (newPosts.length === 0) {
                    loadingIndicator.style.display = "none";
                    observer.disconnect(); // 停止观察
                    return;
                }
        
                newPosts.forEach((post) => {
                    postList.insertAdjacentHTML("beforeend", generatePostHTML(post));
                });
        
                isLoading = false;
                loadingIndicator.style.display = "block";
                observer.observe(loadingIndicator); // 重新观察
            };
        
            const handlePostInteraction = (event) => {
                const button = event.target.closest("button");
                if (!button) return;
        
                const postId = button.dataset.id;
        
                if (button.classList.contains("like-button")) {
                    const icon = button.querySelector("i");
                    const likeCount = parseInt(button.textContent.trim(), 10);
                    const isLiked = button.classList.contains("text-danger");
        
                    button.classList.toggle("text-danger", !isLiked);
                    button.classList.toggle("text-muted", isLiked);
                    icon.classList.toggle("bi-heart-fill", !isLiked);
                    icon.classList.toggle("bi-heart", isLiked);
                    button.innerHTML = `<i class="bi ${!isLiked ? "bi-heart-fill" : "bi-heart"}"></i> ${isLiked ? likeCount - 1 : likeCount + 1}`;
                }
        
                if (button.classList.contains("comment-button")) {
                    alert(`View comments for post ID: ${postId}`);
                }
            };
        
            postList.addEventListener("click", handlePostInteraction);
        
            const observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting && !isLoading) {
                    loadMorePosts();
                    observer.unobserve(loadingIndicator);
                }
            });
        
            observer.observe(loadingIndicator);
        });        
        
    </script>
</body>
</html>